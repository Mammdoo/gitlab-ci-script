.unified-before-base:
  script: |
    set -e -o pipefail
    isFileExist() {
      filePath=$1
      if [ ! -f $filePath ]; then
        return 1
      fi
    }

    nonZeroReturnThenSkip() {
      if [[ $? != 0 ]]; then
          echo "skip message: $1"
          continue
      fi
    }

     nonZeroReturnThenBreak() {
      if [[ $? != 0 ]]; then
          echo "break message: $1"
          break
      fi
    }

     nonZeroReturnThenExit() {
      if [[ $? != 0 ]]; then
          echo "Exit message: $1"
          exit 1
      fi
    }

    fqdn() {
      name=$1
      docker run -it --rm mammdoo/pipeline-assistant:1.1.1 python3 convertFQDN.py $name
    }
    
    if [ -z $CICD_TEMPLATE_PATH ]; then
      export CICD_TEMPLATE_PATH=.gitlab-ci/svc
    fi

    if [ -z $CLUSTER_TARGET ]; then
      export CLUSTER_TARGET=$(docker run -it --rm mammdoo/pipeline-assistant:1.1.1 python3 getCluster.py github $CI_COMMIT_REF_NAME )
    fi

    if [ -z $CI_COMMIT_TAG ]; then
      export MAMMDOO_SERVICE_VERSION=$CI_COMMIT_SHA
    else
      export MAMMDOO_SERVICE_VERSION=$CI_COMMIT_TAG
    fi

    export MAMMDOO_SERVICE_FQDN=$(fqdn $CI_PROJECT_NAME)

.unified-before-docker:
  script: |
    if [ ! -z $DOCKER_REGISTRY_PRIVATE_HOST && ! -z $DOCKER_REGISTRY_PRIVATE_NAMESPACE && ! -z $DOCKER_REGISTRY_PRIVATE_USER && ! -z $DOCKER_REGISTRY_PRIVATE_TOKEN ]; then
      export DOCKER_REGISTRY_PRIVATE=enabled
    fi

    if [ -z $DOCKER_REGISTRY_PUBLIC_STATUS ]; then
      export DOCKER_REGISTRY_PUBLIC_STATUS=$(docker run -it --rm mammdoo/pipeline-assistant:1.1.1 python3 getPublicRegistryStatus.py github $CI_COMMIT_REF_NAME )
    fi

    if [ ! -z $DOCKER_REGISTRY_PUBLIC_HOST && ! -z $DOCKER_REGISTRY_PUBLIC_NAMESPACE ! -z $DOCKER_REGISTRY_PUBLIC_USER && ! -z $DOCKER_REGISTRY_PUBLIC_TOKEN ]; then
      if [[ $DOCKER_REGISTRY_PUBLIC_STATUS == "enabled" ]]; then
        export DOCKER_REGISTRY_PUBLIC=enabled
      fi
    fi

    docker_login() {
      echo "Ready login $DOCKER_REGISTRY_PRIVATE"
      docker login ${DOCKER_REGISTRY_PRIVATE_HOST} --username ${DOCKER_REGISTRY_PRIVATE_USER} --password ${DOCKER_REGISTRY_PRIVATE_TOKEN}

      if [[ $DOCKER_REGISTRY_PUBLIC == "enabled" ]]; then
        echo "Ready login $DOCKER_REGISTRY_PUBLIC"
        docker login ${DOCKER_REGISTRY_PUBLIC_HOST} --username ${DOCKER_REGISTRY_PUBLIC_USER} --password ${DOCKER_REGISTRY_PUBLIC_TOKEN}
      fi
    }

    docker_logout() {
      docker logout ${DOCKER_REGISTRY_PRIVATE_HOST}

      if [[ $DOCKER_REGISTRY_PUBLIC == "enabled" ]]; then
        docker logout ${DOCKER_REGISTRY_PUBLIC_HOST}
      fi
    }

    docker_build() {
      DockerfilePath=$1
      SERVICE_NAME=$2

      docker_args=""
      for arg in `printenv | grep DOCKER_BUILD_ARGS_ | awk -F '=' '{print $1}'`; do
        arg_name=$(echo $arg | sed 's|DOCKER_BUILD_ARGS_||g') 
        docker_args="${docker_args}--build-arg ${arg_name}=${!arg} "
      done

      docker_build_cmdline="docker build -f $DockerfilePath $docker_args -t registry.local/$SERVICE_NAME:$CI_COMMIT_SHA ."
      $docker_build_cmdline
    }

    docker_pull() {
      REGISTRY_URL=$1
      SERVICE_NAME=$2

      set +e
      for i in $(seq 1 90)
      do
        docker pull $REGISTRY_URL/$SERVICE_NAME:$CI_COMMIT_SHA
        if [[ $? -ne 0 ]]; then
          pull_state="fail"
          echo "COMMIT SHA $$CI_COMMIT_SHA} pipeline has not finished , waiting for a moment."
          sleep 10
        else
          pull_state="success"
          break
        fi
      done

      set -e
      if [[ "$pull_state" == "fail" ]]; then
          echo "This workflow failed because ${CI_COMMIT_SHA} image lost, tag only pulling ${CI_COMMIT_SHA} image and docker tag image, pls make sure commit pipeline has success "
          exit 1
      fi

      docker tag $REGISTRY_URL/$SERVICE_NAME:$CI_COMMIT_SHA registry.local/$SERVICE_NAME:$CI_COMMIT_SHA
      docker rmi $REGISTRY_URL/$SERVICE_NAME:$CI_COMMIT_SHA
    }

    docker_push() {
      REGISTRY_URL=$1
      SERVICE_NAME=$2

      docker tag registry.local/$SERVICE_NAME:$CI_COMMIT_SHA $REGISTRY_URL/$SERVICE_NAME:$MAMDOO_SERVICE_VERSION
      docker push $REGISTRY_URL/$SERVICE_NAME:$MAMDOO_SERVICE_VERSION
      docker rmi $REGISTRY_URL/$SERVICE_NAME:$MAMDOO_SERVICE_VERSION
    }

    docker_rmi() {
      SERVICE_NAME=$1
    $CI_COMMIT_SHA=$2

      docker rmi registry.local/$SERVICE_NAME:$CI_COMMIT_SHA
    }

.unified-before-upload:
  script: |
    if [ ! -z $PACKAGE_REGISTRY_GITLAB_URL && ! -z $PACKAGE_REGISTRY_GITLAB_TOKEN ]; then
      export PACKAGE_REGISTRY_GITLAB=enabled
    fi

    rename_jinja_to_yml() {
      file_dir=$1
      file=$2

      file_type=$(echo $file_name | awk -F '.' '{print $NF}')
      file_name=${echo $file_name | sed 's|.[^.]*$||g'}
      
      if [[ $file_type == "j2" ]]; then
        mv $file_dir/$file $file_dir/$file_name.yml
      fi
    }

    package_registry_upload() {
      PACKAGE_REGISTRY_URL=$1
      PACKAGE_REGISTRY_TOKEN=$2
      FILE_PATH=$3

      curl --header "PRIVATE-TOKEN: $PACKAGE_REGISTRY_TOKEN" --upload-file $FILE_PATH $PACKAGE_REGISTRY_URL
    }

    upload_k8s_templates_to_gitlab_package_registry() {
      K8S_TEMPLATE_FILEPATH=$1
      SERVICE_VERSION=$2

      k8s_template_filepath=${CICD_TEMPLATE_PATH}/${SERVICE_NAME}/k8s


      if [ ! -d $k8s_template_filepath ]; then


      if [ -f $K8S_TEMPLATE_FILEPATH/configmap.j2 ]; then
          curl --header "PRIVATE-TOKEN: $token" --upload-file $K8S_TEMPLATE_FILEPATH/configmap.j2 $package_registry_url/configmap.yml
      fi

      if [ -f $K8S_TEMPLATE_FILEPATH/configmap.yml ]; then
          curl --header "PRIVATE-TOKEN: $token" --upload-file $K8S_TEMPLATE_FILEPATH/configmap.yml $package_registry_url/configmap.yml
      fi

      if [ -f $K8S_TEMPLATE_FILEPATH/deployment.j2 ]; then
          curl --header "PRIVATE-TOKEN: $token" --upload-file $K8S_TEMPLATE_FILEPATH/deployment.j2 $package_registry_url/deployment.yml
      fi

      if [ -f $K8S_TEMPLATE_FILEPATH/deployment.yml ]; then
          curl --header "PRIVATE-TOKEN: $token" --upload-file $K8S_TEMPLATE_FILEPATH/deployment.yml $package_registry_url/deployment.yml
      fi

    }

.unified-before-export-demo:
  script: |
